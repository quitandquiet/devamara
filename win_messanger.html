<!doctype html>

<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script type="text/javascript">
    document.oncontextmenu = function(){return false;}
</script>
  
<title>Retro Chat</title>
  
<!-- Galmuri 폰트 로드 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/galmuri/dist/galmuri.css"/>

<style>
:root{
  --bg:#12a692;
  --win98-blue:#000080;
  --win98-gray:#c0c0c0;
  --border-dark:#404040;
  --border-light:#ffffff;
  --text:#000;
  --muted:#555;
}
html,body{
  height:100%;
  margin:0;
  padding:0;
  background:var(--bg);
}
body{
  display:flex;
  align-items:center;
  justify-content:center;
  font-family: 'Galmuri9', sans-serif;
  letter-spacing:-0.5px;
}
.pager-window, .popup{
  width:760px;
  max-width:95%;
  background:var(--win98-gray);
  border:2px solid var(--border-dark);
  display:flex;
  flex-direction:column;
  gap:5px;
  padding:5px;
}
.popup{
  display:none;
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%);
}
.popup .titlebar {
    height:24px;        /* 기존 32px → 텍스트에 맞게 줄임 */
    padding:0 10px;     /* 좌우 여백 유지 */
    display:flex;
    font-size:14px;
    align-items:center; /* 텍스트 수직 중앙 정렬 */
    gap:10px;
    border-bottom:2px solid var(--border-dark);
}
.popup .content, .popup .input-row{
  display:flex;
  flex-direction:column;
  gap:5px;
}
.popup .title-actions .tb-btn{
  width:18px;
  height:18px;
  font-size:12px;
  line-height:18px;
  margin-top:0px;
  padding:0;
  display:flex;
  align-items:center;
  justify-content:center;
}
.titlebar{
  height:24px;
  font-size:14px;
  padding:0 10px;
  background:var(--win98-blue);
  color:white;
  display:flex;
  align-items:center;
  gap:10px;
  border-bottom:2px solid var(--border-dark);
}
.title-icon{
  width:18px;
  height:18px;
  background:#ffeb3b;
  border-radius:2px;
  box-shadow:inset 0 -1px 0 rgba(0,0,0,0.3);
}
.title-actions{
  margin-top: 2px;
  margin-left:auto;
  display:flex;
  gap:4px;
}
.tb-btn{
  width:20px;
  height:18px;
  font-size:12px;
  background:var(--win98-gray);
  border:2px solid var(--border-light);
  border-right-color:var(--border-dark);
  border-bottom-color:var(--border-dark);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
.content{
  display:flex;
  gap:5px;
  padding:0px;
  box-sizing:border-box;
}
.chat-area{
  flex:1;
  display:flex;
  flex-direction:column;
  border:1px solid var(--border-dark);
  background:white;
}
.messages{
  max-height:280px;
  padding:5px;
  overflow:auto;
  font-size:14px;
  line-height:1.4;
  border-bottom:0px solid var(--border-dark);
}
.msg{
  margin-bottom:5px;
}
.msg span{
  color:#333;
}
.system{
  color:var(--muted);
  font-size:12px;
  margin-bottom:5px;
}
.user-list{
  width:120px;
  min-width:100px;
  overflow:auto;
  background:white;
  border:1px solid var(--border-dark);
  padding:5px;
  box-sizing:border-box;
  display:flex;
  flex-direction:column;
  gap:5px;
  height:280px;
}
.user-list h4{
  margin:0 0 4px 0;
  font-size:12px;
  color:var(--muted);
}
.user-item{
  padding:2px 4px;
  display:flex;
  align-items:center;
  gap:5px;
  border:none;
  background:transparent;
  cursor:pointer;
  font-size:13px;
}
.avatar{
  width:15px;
  height:15px;
  background:#ddd;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
}
.online-dot{
  width:9px;
  height:9px;
  border-radius:50%;
  background:#46c35f;
  margin-left:auto;
}
.input-row{
  display:flex;
  gap:5px;
  padding:5px;
  background:#dcdcdc;
  border-top:1px solid var(--border-dark);
}
.input-row textarea{
  flex:1;
  height:80px;
  padding:5px;
  font-size:14px;
  border:1px solid #888;
  resize:none;
}
.send-btn{
  width:90px;
  border:1px solid var(--border-dark);
  background:#e5e5e5;
  font-size:14px;
  cursor:pointer;
}
.popup .user-item-edit{
  display:flex;
  align-items:center;
  gap:5px;
}
.popup input[type=text]{
  flex:1;
  padding:2px;
  font-size:13px;
}
.popup button{
  font-size:12px;
  padding:2px 5px;
  border:1px solid var(--border-dark);
  background:#e5e5e5;
  cursor:pointer;
}
textarea, button, input, select {
    font-family: 'Galmuri9', sans-serif;
}
</style>
</head>

<body>
<div class="pager-window">
  <div class="titlebar">
    <div class="title-icon"></div>
    <div id="chat-title"></div>
    <div class="title-actions">
      <div class="tb-btn" id="min-btn">_</div>
      <div class="tb-btn" id="max-btn">□</div>
      <div class="tb-btn" id="close-btn">X</div>
    </div>
  </div>

  <div class="content">
    <div class="chat-area">
      <div class="messages" id="messages"></div>
    </div>

    <div class="user-list" id="user-list">
      <h4>Users</h4>
    </div>
  </div>

    <div class="input-row">
    <textarea id="msg-input" placeholder="메시지를 입력하세요"></textarea>
    <button class="send-btn" id="send-btn">Send</button>
  </div>
</div>
  
  <div class="popup" id="user-popup">
  <div class="titlebar">
    <div class="title-icon"></div>
    <div>User Management</div> 
    <div class="title-actions">
      <div class="tb-btn" id="close-popup">X</div>
    </div>
  </div>

  <div class="content" id="popup-content"></div>
  <div class="input-row">
    <input type="text" id="new-user-name" placeholder="New user name">
    <button id="add-user-btn">Add</button>
  </div>
</div>

  <div class="popup" id="title-popup">
  <div class="titlebar">
    <div class="title-icon"></div>
    <div>Edit Chat Title</div>
    <div class="title-actions">
      <div class="tb-btn" id="close-title-popup">X</div>
    </div>
  </div>

  <div class="content">
    <input type="text" id="title-input" placeholder="New chat title">
    <button id="save-title-btn">Save</button>
  </div>
</div>

<script>

function randomUser(){
  return 'user'+Math.floor(100000+Math.random()*900000);
}

let currentUser=randomUser();
const chatTitle=document.getElementById('chat-title');
chatTitle.textContent='Chat with '+currentUser;

let users=[
  {name:randomUser(), online:true},
  {name:randomUser(), online:true},
  {name:randomUser(), online:true}
];

const messagesEl=document.getElementById('messages');
const userListEl=document.getElementById('user-list');
const popup=document.getElementById('user-popup');
const popupContent=document.getElementById('popup-content');
const titlePopup=document.getElementById('title-popup');

function saveMessages(){
  localStorage.setItem('chatMessages',messagesEl.innerHTML);
}
function loadMessages(){
  messagesEl.innerHTML=localStorage.getItem('chatMessages')||'';
}

function renderUsers(){
    userListEl.innerHTML='<h4>Users</h4>';

    users.forEach(u=>{
        const div=document.createElement('div');
        div.className='user-item';

        const avatar=document.createElement('div');
        avatar.className='avatar';
        avatar.textContent=u.name[0];

        const nameSpan=document.createElement('span');
        nameSpan.textContent=u.name;

        const status=document.createElement('div');
        status.className='online-dot';
        status.style.background=u.online?'#46c35f':'#888';

        div.appendChild(avatar);
        div.appendChild(nameSpan);
        div.appendChild(status);

        div.onclick=()=>{
            currentUser=u.name;

            // 사용자 선택 팝업 통일
            let chatWithPopup=document.getElementById('chat-with-popup');
            if(!chatWithPopup){
                chatWithPopup=document.createElement('div');
                chatWithPopup.className='popup';
                chatWithPopup.id='chat-with-popup';
                chatWithPopup.innerHTML=`
                    <div class="titlebar">
                        <div class="title-icon"></div>
                        <div id="chat-with-title">Chat</div>
                        <div class="title-actions">
                            <div class="tb-btn" id="close-chat-with">X</div>
                        </div>
                    </div>
                    <div class="content" style="padding:5px;">사용자 ${u.name}와 채팅 시작</div>
                `;
                document.body.appendChild(chatWithPopup);

                // 닫기 버튼
                chatWithPopup.querySelector('#close-chat-with').onclick=()=>{
                    chatWithPopup.style.display='none';
                };
            }

            chatWithPopup.querySelector('#chat-with-title').textContent='Chat with '+u.name;
            chatWithPopup.querySelector('.content').textContent='사용자 '+u.name+'와 채팅 시작';
            chatWithPopup.style.display='flex';
        };

        userListEl.appendChild(div);
    });
}

function sendMessage(){
  const input=document.getElementById('msg-input');
  if(input.value.trim()==='')return;
  const div=document.createElement('div');
  div.className='msg';
  div.innerHTML='<span>'+currentUser+':</span> '+input.value;
  messagesEl.appendChild(div);
  input.value='';
  messagesEl.scrollTop=messagesEl.scrollHeight;
  saveMessages();
}

function renderPopup(){
  popupContent.innerHTML='';
  users.forEach((u,i)=>{
    const div=document.createElement('div');
    div.className='user-item-edit';
    const input=document.createElement('input');
    input.value=u.name;
    input.addEventListener('change',()=>{
      u.name=input.value;
      renderUsers();
    });
    const checkbox=document.createElement('input');
    checkbox.type='checkbox';
    checkbox.checked=u.online;
    checkbox.addEventListener('change',()=>{
      u.online=checkbox.checked;
      renderUsers();
    });
    const delBtn=document.createElement('button');
    delBtn.textContent='Delete';
    delBtn.onclick=()=>{
      users.splice(i,1);
      renderUsers();
      renderPopup();
    };
    div.appendChild(input);
    div.appendChild(checkbox);
    div.appendChild(delBtn);
    popupContent.appendChild(div);
  });
}

document.getElementById('send-btn').onclick=sendMessage;
document.getElementById('msg-input').addEventListener('keydown',e=>{
  if(e.key==='Enter'&&!e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});
document.getElementById('close-btn').onclick=()=>{
  messagesEl.innerHTML='';
  currentUser=randomUser();
  chatTitle.textContent='Chat with '+currentUser;
  saveMessages();
};
document.getElementById('max-btn').onclick=()=>{
  document.getElementById('title-input').value=chatTitle.textContent;
  titlePopup.style.display='flex';
};
document.getElementById('save-title-btn').onclick=()=>{
  const val=document.getElementById('title-input').value.trim();
  if(val) chatTitle.textContent=val;
  titlePopup.style.display='none';
};
document.getElementById('close-title-popup').onclick=()=>{
  titlePopup.style.display='none';
};
document.getElementById('min-btn').onclick=()=>{
  popup.style.display='flex';
  renderPopup();
};
document.getElementById('close-popup').onclick=()=>{
  popup.style.display='none';
};
document.getElementById('add-user-btn').onclick=()=>{
  const nameInput=document.getElementById('new-user-name');
  if(nameInput.value.trim()==='')return;
  users.push({name:nameInput.value,online:true});
  nameInput.value='';
  renderUsers();
  renderPopup();
};

loadMessages();
renderUsers();
</script></body>
</html>
